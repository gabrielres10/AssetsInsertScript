DROP TABLE IF EXISTS default_email_templates CASCADE;
DROP TABLE IF EXISTS email_templates CASCADE;
DROP TABLE IF EXISTS template_type_vars CASCADE;
DROP TABLE IF EXISTS template_type CASCADE;

CREATE TABLE public.template_type ( 
    id int8 GENERATED BY DEFAULT AS IDENTITY( 
        MINVALUE 0 
        NO MAXVALUE 
        START 0 
        NO CYCLE
    ) 
    NOT NULL, 
    "name" varchar(255) NOT NULL, 
    CONSTRAINT template_type_name_check CHECK ((((name)::text = ANY ((ARRAY['RESET_PASSWORD'::character varying, 'RETURN_ASSETS'::character varying, 'ASSET_REQUEST'::character varying])::text[])))), 
    CONSTRAINT template_type_pkey PRIMARY KEY (id), 
    CONSTRAINT template_type_name_unique UNIQUE ("name"));


CREATE TABLE public.template_type_vars (
    template_type_id int8 NOT NULL, 
    vars varchar(255) NOT NULL, 
    CONSTRAINT template_type_vars_template_type_fk FOREIGN KEY (template_type_id) REFERENCES public.template_type(id)
    );

CREATE TABLE public.email_templates ( 
    id int8 GENERATED BY DEFAULT AS IDENTITY(
        MINVALUE 0 
        NO MAXVALUE 
        START 0 
        NO CYCLE
    ) 
    NOT NULL, 
    body text NOT NULL, 
    "name" varchar(255) NOT NULL, 
    subject varchar(255) NOT NULL, 
    template_type_id int8 NOT NULL, 
    CONSTRAINT email_templates_pkey PRIMARY KEY (id), 
    CONSTRAINT email_template_name_unique UNIQUE ("name"), 
    CONSTRAINT email_template_template_type_fk FOREIGN KEY (template_type_id) REFERENCES public.template_type(id));

CREATE TABLE public.default_email_templates ( 
    id int8 GENERATED BY DEFAULT AS IDENTITY(
        MINVALUE 0 
        NO MAXVALUE 
        START 0 
        NO CYCLE
    ) NOT NULL,
    email_template_id int8 NOT NULL, 
    template_type_id int8 NOT NULL, 
    CONSTRAINT default_email_templates_pkey PRIMARY KEY (id), 
    CONSTRAINT default_email_templates_template_type_id_unique UNIQUE (template_type_id), 
    CONSTRAINT default_email_templates_email_templates_fk FOREIGN KEY (email_template_id) REFERENCES public.email_templates(id), 
    CONSTRAINT default_email_templates_template_type_fk FOREIGN KEY (template_type_id) REFERENCES public.template_type(id));


INSERT INTO template_type (id, "name") VALUES(1, 'RESET_PASSWORD');
INSERT INTO template_type (id, "name") VALUES(2, 'RETURN_ASSETS');
INSERT INTO template_type (id, "name") VALUES(3, 'ASSET_REQUEST');

INSERT INTO template_type_vars (template_type_id, vars) VALUES(1, 'link');
INSERT INTO template_type_vars (template_type_id, vars) VALUES(3, 'company_name');
INSERT INTO template_type_vars (template_type_id, vars) VALUES(3, 'full_name');
INSERT INTO template_type_vars (template_type_id, vars) VALUES(3, 'corporate_phone');
INSERT INTO template_type_vars (template_type_id, vars) VALUES(3, 'city');
INSERT INTO template_type_vars (template_type_id, vars) VALUES(3, 'position');
INSERT INTO template_type_vars (template_type_id, vars) VALUES(3, 'corporate_email');
INSERT INTO template_type_vars (template_type_id, vars) VALUES(3, 'requirements');
INSERT INTO template_type_vars (template_type_id, vars) VALUES(3, 'asset');
INSERT INTO template_type_vars (template_type_id, vars) VALUES(2, 'sender_name');
INSERT INTO template_type_vars (template_type_id, vars) VALUES(2, 'company');
INSERT INTO template_type_vars (template_type_id, vars) VALUES(2, 'return_date');
INSERT INTO template_type_vars (template_type_id, vars) VALUES(2, 'return_address');
INSERT INTO template_type_vars (template_type_id, vars) VALUES(2, 'return_city');
INSERT INTO template_type_vars (template_type_id, vars) VALUES(2, 'contact_name');
INSERT INTO template_type_vars (template_type_id, vars) VALUES(2, 'contact_email');
INSERT INTO template_type_vars (template_type_id, vars) VALUES(2, 'contact_phone');
INSERT INTO template_type_vars (template_type_id, vars) VALUES(2, 'assets_list');

INSERT INTO email_templates (id, body, "name", subject, template_type_id) VALUES
(8, '<p>Hola,</p><p>Haz clic en el siguiente enlace para restablecer tu contraseña:</p><p>{link}</p><p>Si no solicitaste este cambio, por favor ignora este mensaje.</p><p>Este enlace expirará en 1 hora.</p>', 'Cambio de Contraseña', 'Recuperación de contraseña', 1),
(15, '<p>Se ha recibido una solicitud de activo tecnológico con la siguiente información:</p><p>- Empresa: {company_name}</p><p>- Nombre completo: {full_name}</p><p>- Teléfono corporativo: {corporate_phone}</p><p>- Ciudad: {city}</p><p>- Cargo: {position}</p><p>- Correo electrónico: {corporate_email}</p><p>- Activo solicitado:</p><p>{asset}</p><p>Requerimientos adicionales:</p><p>{requirements}</p>', 'Solicitud de Activo', 'Solicitud de Activo Tecnológico', 3),
(16, '<p>El usuario {sender_name} de la empresa {company}, ha solicitado la recogida para el día {return_date}.</p><p></p><p>Los equipos serán entregados en la dirección: {return_address} - {return_city}</p><p></p><p>Persona de contacto: {contact_name}</p><p>Correo: {contact_email}</p><p>Teléfono: {contact_phone}</p><p></p><p>Equipos solicitados para la devolución</p><p>{assets_list}</p>', 'Devolución de activos', 'Devolución de Activos Tecnológicos', 2);


INSERT INTO default_email_templates (id, email_template_id, template_type_id) VALUES(9, 8, 1);
INSERT INTO default_email_templates (id, email_template_id, template_type_id) VALUES(10, 15, 3);
INSERT INTO default_email_templates (id, email_template_id, template_type_id) VALUES(11, 16, 2);